# JDBC

### JDBC(Java Database Connectivity)란?

**정의**: 자바에서 DB에 접속, 쿼리를 보내고, 결과를 받아오기 위한 API

<br>

**특징**

- **표준화**: DB가 바뀌어도 자바 코드는 크게 바뀌지 않음.
- **Low-Level**: 개발자가 DB 연결의 모든 과정을 직접 제어.

<br>

**단점**

- **반복 코드(Boilerplate Code)**: 쿼리 하나를 위해 작성해야 할 코드가 많음.
- **리소스 관리 어려움**: `Connection`, `Statement` 등을 쓰고 나면 반드시 `close()`를 해줘야 함.
- **체크 예외(Checked Exception)**: `SQLException`을 강제로 예외 처리(`try-catch`) 해야 함.

<br>
<br>

### Spring JDBC (주로 JdbcTemplate)란?

**정의**: JDBC API를 더 쉽게 사용할 수 있도록 Spring Framework에서 제공하는 추상화 라이브러리

<br>

**특징**

- **반복 제거**: `Connection` 연결/종료, `Statement` 생성 등을 스프링이 알아서 해줌.
- **예외 변환**: `SQLException`을 스프링의 `DataAccessException` (***언체크 예외**)로 바꿔줌. `try-catch` 사용 안 해도 됨.
- **편의 기능**: `RowMapper` 등을 통해 결과를 자바 객체로 쉽게 매핑해줌.

<br>

**단점**

- **SQL 직접 작성**: 여전히 개발자가 SQL을 직접 짜야함. (JPA와의 차이점)
- **동적 쿼리의 어려움**: 조건에 따라 쿼리가 바뀌는 복잡한 SQL을 자바로 짜기에는 번거로움이 존재.

> [!TIP]
> - ***언체크 예외**: 컴파일러가 예외 처리를 강제하지 않는 런타임 예외

<br>
<br>


### @Repository

**정의**: DB에 접근하는 DAO(Data Access Object) 클래스에 붙이는 스프링 어노테이션

<br>

**특징**

- **스프링 빈 등록**:
    - 스프링이 시작될 때 자동으로 해당 클래스를 Bean으로 만들어 관리.
- **예외 변환 (Exception Translation)**:
    - DB마다 에러가 다름 (Oracle의 에러, MySQL의 에러, H2의 에러 등)
    - `@Repository`가 붙어 있으면, 각 DB의 고유한 체크 예외를 스프링의 공통 언체크 예외(`DataAccessException`)으로 자동 변환해 줌.

<br>
<br>

### “”” “””  (텍스트 블록)

**정의**: 여러 줄의 문자열을 편하게 작성할 수 있게 해주는 기능. Java 15부터 도입된 문법

<br>

**특징**

- **줄 바꿈 문자 불필요**
- **가독성**
- **따옴표 탈출 불필요**: `"`가 있어도 `\`가 필요 없음

<br>

**사용 예시**

```java
// 텍스트 블록 사용 예시

// 텍스트 블록 사용 X
String INSERT_QUERY = "insert into course (id, name, author) \n" +
        "values(?, ?, ?)";

// 텍스트 블록 사용 O
String INSERT_QUERY = """
        insert into course (id, name, author)
        values(?, ?, ?)
        """;
```

<br>
<br>

### CommandLineRunner

**정의**: 스프링 부트 애플리케이션이 **구동된 직후**, **딱 한 번만 실행**하고 싶은 코드가 있을 때 사용하는 인터페이스

<br>

**특징**

- **실행 시점**: `SpringApplication.run()`이 완료되기 직전에 실행됨. 서버가 켜지자마자 무언갈 해야 할 때 사용.
    - **e.g.** 초기 데이터 세팅, DB 연결 상태 점검, 파일 경로 점검 등

<br>

**사용법**

- `CommandLineRunner` 인터페이스를 구현하고, `run` 메서드 안에 로직을 짬

```java
// CommandLineRunner 사용 예시

@Component
public class CourseCommandLineRunner implements CommandLineRunner {

    @Autowired
    private CourseSpringDataJpaRepository repository;
    
    @Override
    public void run(String... args) throws Exception {
        repository.save(new Course(1, "Learn AWS jpa!", "MOIYS"));
        repository.save(new Course(2, "Learn Azure jpa!", "MOIYS"));
    }
}
```

<br>
<br>

### queryForObject

**정의**: `JdbcTemplate`가 제공하는 메서드. 쿼리의 실행 결과가 정확히 1행일 때 사용하는 조회 메서드

<br>

**특징**

- **결과 반환**: SQL 실행 결과를 개발자가 지정한 **객체 하나로 매핑**해서 반환
- **제네릭 지원**: 사용자 정의 객체로도 반환 가능

<br>

**단점**

- **조회된 데이터가 정확히 1건이 아닌 경우**
    - 조회된 데이터가 0건이거나, 2건 이상이면 **예외 발생**
        - 0건일 때: `EmptyResultDataAccessException` 발생
        - 2건 이상일 때: `IncorrectResultSizeDataAccessException` 발생
    - 따라서 결과가 없을 수도 있는 상황이라면, `try-catch`로 감싸거나 `query()` 메서드를 사용해서 비어있는지 확인해야 함

<br>

 **사용처**

- **PK로 조회**할 때
- **Count**나 **Sum**을 구할 때

<br>
<br>

### BeanPropertyRowMapper

**정의**: DB에서 조회한 결과를 Bean으로 변환해주는 RowMApper 인터페이스 구현체

<br>

**특징**

- **규칙 기반 매핑**: 자바의 **Setter 메서드**를 사용하여 데이터를 넣음.
- **이름 자동 변환**: DB의 스네이크 표기법(user_name)을 자바의 카멜 표기법(userName)으로 자동으로 변환해줌.

<br>

**단점**

- **기본 생성자 필수**: 내부적으로 `new 객체()`를 먼저 호출하고 Setter를 사용하기 때문에, 기본 생성자가 있어야 함.
- **Setter 필수**

<br>

**사용 예시**

```java
// BeanPropertyRowMapper 사용 예시

public Course findById(long id) {
		return springJdbcTemplate.queryForObject(SELECT_QUERY,
				new BeanPropertyRowMapper<>(Course.class), id);
	}
```

<br>
<br>

### BeanPropertyRowMapper vs DataClassRowMapper
| **구분** | BeanPropertyRowMapper | DataClassRowMapper |
| --- | --- | --- |
| **주 사용 대상** | 일반 `class` | `record` 또는 불변 객체  |
| **동작 방식** | 1. 기본 생성자로 객체 <br> 2. Setter로 값 주입 | 1. 모든 필드를 포함한 생성자를 찾아서 <br> 2. 생성자 파라미터로 한 번에 주입 |
| **필수 조건** | 기본 생성자, Setter | 매개변수가 있는 생성자 (DB 컬럼명과 생성자 변수명이 일치해야 함) |
| **`record` 지원** | X | O |
| **불변성** | 불변 객체 못 만듦 | 불변 객체 생성 가능 |