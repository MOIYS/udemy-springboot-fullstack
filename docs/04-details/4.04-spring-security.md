## Spring Security

**정의**: 스프링 기반 애플리케이션의 보안 기능을 담당하는 표준 프레임워크

<br>

**특징**

- **Filter 기반 동작**
    - 스프링 MVC(`DispatcherServlet`)에 도달하기 전에, 서블릿 필터 단계에서 미리 요청을 가로채서 검사
- **커스터마이징**
    - 로그인 방식, 비밀번호 암호화 방식 등을 커스터마이징할 수 있음

**역할**

- **인증(Authentication) / 인가(Authorization)**

<br>

### Authentication

**정의**: 현재 인증된 사용자 정보(Principal), 자격 증명(Credentials), 권한(Authorities)을 담은 컨테이너

<br>

**주요 메서드**

- `getPrincipal()`: 사용자 정보 객체인 `UserDetails` 혹은 `String` 반환
- `getCredentials()`: 사용자가 입력한 비밀번호 반환
- `getAuthorities()`: 권한 목록을 리스트로 반환
- `isAuthenticated()`: 인증에 성공한 사용자인지 true/false로 반환

<br>

**생명주기**

1. **로그인 시도 중**: 사용자가 ID/PW를 입력하면, 임시 `Authentication` 객체 생성
(`isAuthenticated()==false`)
2. **검사 중**: `AuthenticationManager`가 해당 객체를 받아서DB와 비교 검사
3. **로그인 성공**: 검사가 통과되면, 사용자 정보가 채워진 새 `Authentication` 객체를 만들어서 `SecurityContext`에 저장 (`isAuthenticated()==true`)

```java
// Authentication 사용 예시
private String getLoggedinUsername() {
		Authentication authentication =
    SecurityContextHolder.getContext().getAuthentication();
        
    return authentication.getName();
}
```

<br>
<br>

### Principal

**정의**: 현재 인증된 사용자 정보를 가지고 있는 객체

**기능**: 현재 로그인한 사용자의 ID나 정보를 꺼내볼 수 있음

```java
// Principal 사용 예시
@GetMapping("list-todos")
public String listAllTodos(ModelMap model, Principal principal) {
    String username = **principal.getName();**
```

<br>
<br>

### UserDetails

**정의**: Spring Security에서 사용자 정보를 담는 인터페이스

```java
// UserDetails 사용 예시
**UserDetails** userDetails = User.builder()
            .passwordEncoder(passwordEncoderFunction)
            .username(username)
            .password(password)
            .roles("USER", "ADMIN")
            .build();
```

<br>
<br>

### InMemoryUserDetailsManager

**정의**: 사용자 정보를 DB가 아닌, RAM에 저장하고 관리하는 매니저

**특징**

- 서버를 끄면 정보가 전부 사라짐
- 설정이 간편함 → 학습, 테스트용

```java
// InMemoryUserDetailsManager 사용 예시
@Bean
public InMemoryUserDetailsManager createUserDetailsManager() {
    UserDetails userDetails1 = createUser("MOIYS", "qwer");
    UserDetails userDetails2 = createUser("Lee", "asdf");

    return new **InMemoryUserDetailsManager**(userDetails1, userDetails2);
}
```

<br>
<br>

### PasswordEncoder

**정의**: 비밀번호를 해싱하는 인터페이스

**특징**

- **단방향 암호화**
- **BCrypt**: 많이 쓰이는 해싱 알고리즘 중 하나 ****
    - BCryptPasswordEncoder()

```java
// PasswordEncoder & BCryptPasswordEncoder 사용 예시
@Bean
public **PasswordEncoder** passwordEncoder() {
		return new **BCryptPasswordEncoder()**;
}
```

<br>
<br>

### **로그인 전체 동작 흐름**

1. **요청**:  ID/PW 입력 → 로그인 요청
2. **요청 가로채기**: `AuthenticationFilter`가 요청을 잡음
3. **위임**: Filter가 `AuthenticationManager`에게 해당 유저 인증을 위임함
4. **조회**: Manager가 `UserDetailsService`에게 해당 계정이 DB에 있는지 확인 시킴
5. **검증**: 가져온 `UserDetails`의 암호화된 PW와, 사용자가 입력한 PW가 일치하는지 확인 (`PasswordEncoder`로 확인)
6. **인증 성공**: 일치하면 `Principal` (인증 토큰)을 만들어서 세션(`SecurityContext`)에 저장

<br>
<br>
<br>

## Function 메서드

**정의**: 입력값 하나(T)를 받아서 처리한 뒤, 결과값 하나(R)를 반환하는 함수형 인터페이스

<br>

- **구조**: `Function<T, R>`
    - **T (Type)**: Input
    - **R (Return)**: Output

```java
// Function 사용 예시
@Nonnull
private UserDetails createUser(String username, String password) {
		Function<String, String> passwordEncoderFunction
	    = input -> passwordEncoder().encode(input);
```

<br>
<br>
<br>

## CSRF와 Security 설정

### CSRF(Cross-Site Request Forgery)

**정의**: 사이트 간 요청 위조 공격

<br>
<br>

### SecurityFilterChain

**정의**: Spring Security의 모든 보안 규칙을 정의하는 설정값들의 집합

- **`throws Exception` 필수**
    - HttpSecurity 메서드들에 `throws Exception`이 붙어있기 때문에

```java
// SecurityFilterChain 사용 예시
@Bean
public **SecurityFilterChain** filterChain(**HttpSecurity** http) throws Exception {
		http.authorizeHttpRequests(
	    auth -> auth.anyRequest().authenticated());

      http.formLogin(Customizer.withDefaults());

      http.csrf(AbstractHttpConfigurer::disable);

      http.headers(headers -> headers.frameOptions(HeadersConfigurer.FrameOptionsConfig::disable));

      return http.build();
}
```

<br>
<br>

### HttpSecurity

**정의**:  웹 요청에 대한 인증 및 인가 규칙을 빌더 패턴을 통해 설정하는 설정 빌더 객체. `SecurityFilterChain`을 만들 때 사용 

**기능**: `.csrf()`, `authorizeHttpRequests()`, `formLogin()` 등 보안, 요청 권한, 인증 방식 등을 설정할 수 있음

<br>
<br>

### authorizeHttpRequests

**정의**: 누가 어떤 URL에 접근할 수 있는지, HTTP 요청에 대한 권한 부여를 설정하는 메서드

<br>
<br>

### Frames & FrameOptions

- **frame**: 웹 페이지 안에 또 다른 작은 웹 브라우저 창을 띄우는 기술
- **문제 상황**: Spring Security는 Clickjacking을 막기 위해서 기본적으로 `<iframe>` 태그를 못 쓰게 함
- **H2 Console**: H2 Console 화면은 내부적으로 `<frame>`을 사용함
- **해결**: `.headers(headers -> headers.frameOptions(HeadersConfigurer.FrameOptionsConfig::disable));`을 통해 내가 설정한 주소와 같은 사이트끼리는 프레임을 허용함

<br>
<br>
<br>

## Logging

### org.slf4j (인터페이스)

**정의**: **S**imple **L**ogging **F**acade **4** **J**ava. 자바 로깅의 표준 인터페이스

<br>


### Logger & LoggerFactory

- **Logger**: 실제 로그를 기록하는 객체
- **LoggerFactory**: `Logger` 객체를 생성해주는 팩토리
```java
// Logger & LoggerFactory 사용 예시
private Logger logger = LoggerFactory.getLogger(getClass());
```